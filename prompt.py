# -*- coding: utf-8 -*-

import openai
import os
import datetime
import time
import tiktoken
#import json
#import requests




def generate_journal(prompt):
    #d = datetime.datetime.now() - datetime.timedelta(days=1) #ì–´ì œ ë‚ ì§œë¡œ ì¼ê¸° ì‘ì„±
    #date=f'{str(d.year%100):0>2}.{str(d.month):0>2}.{str(d.day):0>2}'
    #week=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼']
    #weekday=week[d.weekday()]
    #tokenizer = tiktoken.encoding_for_model("gpt-3.5-turbo")
    #print(text)
    
    start=time.time()
    openai.api_key = os.getenv("OPENAI_API_KEY") 
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo-0613",
        messages=[{"role": "user", "content":f"{prompt}"}],
        temperature=0.2
        )
    end=time.time()
    #print(end-start,'sec')
    """
    print(response.usage)
    output=response.choices[0].message.content
    print(output)
    """
    
    return response.choices[0].message.content, end-start

def make_prompt(age,gender,job,memolet_list):
    let=''
    for i in range(len(memolet_list)):
        date=memolet_list[i].get('dateTime')
        let+=f"{i+1}. {date[5:10]} {date[11:16]} {memolet_list[i].get('memoLet')}\n"
    now_date=(datetime.datetime.now()-datetime.timedelta(days=1)).strftime('%m-%d')
    text=f"ë„ˆëŠ” {age}ì„¸ {gender} {job}ì˜ ì…ì¥ì—ì„œ ì£¼ì–´ì§„ ì¡°ê±´ì— ë”°ë¼ ì¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ëŠ” assistantì•¼.\nì•„ë˜ \'\'\'ë¡œ êµ¬ë¶„ëœ ë‚´ìš©ì„ í•©ì³ í•˜ë‚˜ì˜ ì¼ê¸°ë¥¼ ì¨ì¤˜.\nì´ë•Œ ì¼ê¸°ì—ëŠ” [ì œëª©], [ë‚´ìš©], [í‚¤ì›Œë“œ]ê°€ í¬í•¨ë˜ë„ë¡ í•´ì¤˜.\ní‚¤ì›Œë“œëŠ” ë°˜ë“œì‹œ 3ê°œë¡œ ë½‘ì•„ì¤˜.\n1.,2.,3.ê³¼ ê°™ì´ êµ¬ë¶„ëœ ê° ë‚´ìš©ë“¤ì€ ì˜¤ëŠ˜ í•˜ë£¨ ìˆì—ˆë˜ ì¼ë“¤ì´ì•¼.\nì¼ê¸°ì— êµ¬ì²´ì ì¸ ì‹œê°„ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆ.\nê·¸ë¦¬ê³  ì‹œê°„ì˜ íë¦„ë§Œ ë°˜ì˜í•´ ì¼ê¸°ë¥¼ ê³¼ê±°í˜•ìœ¼ë¡œ ì¨ì¤˜.\nì¼ê¸° ë‚´ìš©ì€ ì•„ë˜ \'\'\'ë¡œ êµ¬ë¶„ëœ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, ê³¼ë„í•œ ì¶”ì¸¡ì€ í•˜ì§€ ë§ˆ.\nì œëª©ì€ ì˜¤ëŠ˜ í•˜ë£¨ ìˆì—ˆë˜ ì¼ì˜ í•µì‹¬ì„ ìš”ì•½í•´ì¤˜.\n\n\'\'\'\n{let}\'\'\'"
    
    return text

def generate_keyword():
    text=f"ì•„ë˜ \'\'\'ë¡œ êµ¬ë¶„ëœ ê° ë¬¸ë‹¨ì„ ëŒ€í‘œí•  ìˆ˜ ìˆëŠ” í‚¤ì›Œë“œë¥¼ 1~3ê°œ ì •ë„ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•´ì„œ ë½‘ì•„ì¤˜.\n\n\
    \'\'\'\n\
    1. ê³¼ì œ... í•  ê±´ ë§ì€ë° ë§‰ìƒ ê³¼ì œ í•˜ëŸ¬ ë“¤ì–´ê°€ë©´ ë­ë¶€í„° ì†ëŒ€ì•¼ í• ì§€ ê°ì´ ì•ˆ ì˜¨ë‹¤. ê·¸ë˜ë„ ì œì¼ ì–´ë ¤ìš´ ë¶€ë¶„ ì˜¤ëŠ˜ ëë‚´ì„œ ë‚´ì¼ì´ë©´ ì–¼ì¶” ì™„ì„±ì‹œí‚¬ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤\n\
    2. ì ì‹¬ìœ¼ë¡œ ì¹œêµ¬ë“¤ì´ë‘ ì´ˆë°¥ ë¨¹ì—ˆë‹¤ ë§›ì€ ê·¸ëƒ¥ ë¬´ë‚œ! ì§€ê¸ˆ ë°¥ ë‹¤ ë¨¹ê³  ì¹œêµ¬ë“¤ì´ë‘ ëŒ€ì™¸í™œë™ ìë£Œ ì‘ì„± ì ê¹ í•˜ë‹¤ê°€ í—¤ì–´ì ¸ì„œ í•™ì‚¬ ê°€ëŠ” ê¸¸ì¸ë°... ë„ˆë¬´ í”¼ê³¤í•˜ë‹¤\n\
    3. ë„˜ì¡¸ë ¤ì„œ ì¡°ê¸ˆë§Œ ìê³  ê³¼ì œí•´ì•¼í• ë“¯... ì§„ì§œí”¼ê³¤í•˜ë‹¤ì•„ì•…\n\
    4. ì €ë…ë¨¹ê³  ì‚°ì±…ë‚˜ì™”ë‹¤! ê¸°ë¶„ ì¢‹ìŒ\n\
    5. ì €ë… ë¨¹ê³  ì”ê¹ ì‚°ì±…ë‚˜ì™”ëŠ”ë° ë©”ê°€ì»¤í”¼ ì•ì—ì„œ ì‚¬ê°ìŒ¤ ë§ˆì£¼ì³¤ë‹¤! ì‚¬ê°ìŒ¤ì´ ë¨¹ê³ ì‹¶ì€ ê±° ì‚¬ì£¼ì‹ ë‹¤ê³  ì–¼ë¥¸ ê³ ë¥´ë˜ì„œ ë°•ì›¬ìˆ˜ë‘ ë‚˜ë‘ ë§ˆì¹´ë¡± í•˜ë‚˜ ìŠˆí¬ë¦¼ë¹µ í•˜ë‚˜ ê³¨ëìŒ... ì•„ê»´ë’€ë‹¤ ë‚˜ì¤‘ì— ë¨¹ì–´ì•¼ì§€\n\
    \'\'\'"
    start=time.time()
    openai.api_key = os.getenv("OPENAI_API_KEY") 
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "system", "content": f"ë„ˆëŠ” ì£¼ì–´ì§„ ë¬¸ì¥ì„ ëŒ€í‘œí•  ìˆ˜ ìˆëŠ” ì ì ˆí•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ëŠ” assistantì•¼."},
            {"role": "user", "content": f"{text}"}]
        )
    end=time.time()
    print(end-start,'sec')
    output=response.choices[0].message.content
    return output

if __name__ == "__main__":
    user = {
        "userDto": {
            "kakaoId": "101010",
            "username": "ë¯¼ì„œ",
            "age": 23,
            "gender": "ì—¬ì",
            "job": "ì œë¹µì‚¬"
        },
        "todayStampList": [
            {
                "kakaoId": "101010",
                "dateTime": "2023-07-04T20:12:00",
                "stamp": "í”¼ê³¤",
                "memoLet": "ì˜¤ëŠ˜ ì‹œì›í•˜ê²Œ ì…ì–´ì„œ ê¸°ë¶„ì´ ì¢‹ë‹¤"
            },
            {
                "kakaoId": "101010",
                "dateTime": "2023-07-04T22:22:00",
                "stamp": "ìš°ìš¸",
                "memoLet": "ê°œë°œì´ ì˜ ì•ˆëœë‹¤ë¬´....."
            },
            {
                "kakaoId": "101010",
                "dateTime": "2023-07-04T22:23:00",
                "stamp": "í”¼ê³¤",
                "memoLet": "ë‚¨ìì¹œêµ¬ê°€ ë°ë¦¬ëŸ¬ ì˜¨ëŒ• ã…ã…"
            },
            {
                "kakaoId": "101010",
                "dateTime": "2023-07-04T22:24:00",
                "stamp": "ìš°ìš¸",
                "memoLet": "ê·¸ëƒ¥ í•œ ë²ˆ ë” ëˆŒëŸ¬ë´¤ì–´"
            }
        ]
    }

    # ë”•ì…”ë„ˆë¦¬ë¥¼ JSONìœ¼ë¡œ ë³€í™˜ 
    
    user_data=user.get('userDto')
    prompt=make_prompt(user_data.get('age'),user_data.get('gender'),user_data.get('job'),user.get('todayStampList'))
    print(prompt)
    
    for i in range(3):
        print('-----------',i+1,'íšŒì°¨------------')
        journal,running_time=generate_journal(prompt)
        print(journal)
        print(running_time)



"""
{
    "userDto": {
        "kakaoId": "101010",
        "username": "ì´ë¯¼ê·œ",
        "age": 22,
        "gender": "ë‚¨ì",
        "job": "ëŒ€í•™ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "13:12:00",
            "dateTime": "2023-06-25T13:12:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "ì ì‹¬ìœ¼ë¡œ ë§›ìˆëŠ” íƒ€ì½”ì•¼ë¼ì™€ ë¶ˆë‹­ë³¶ìŒë©´ì„ ë¨¹ì—ˆì–´ìš”."
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "14:50:00",
            "dateTime": "2023-06-25T14:50:00",
            "stamp": "ìŠ¬í””",
            "memoLet": "í‡´ê²€ì„ ìœ„í•´ ì²­ì†Œí•˜ëŠë¼ í—ˆë¦¬ê°€ ì•„íŒŒìš”"
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "19:10:00",
            "dateTime": "2023-06-25T19:10:00",
            "stamp": "ì¡¸ë¦¼",
            "memoLet": "ë“œë””ì–´ ì²­ì†Œê°€ ëë‚¬ì–´ìš”. ì €ë…ìœ¼ë¡œ ë°°ë‹¬ê¸±ì— ìƒˆë¡œ ìƒê¸´ ë‹­ê°•ì •ì„ ë¨¹ì—ˆì–´ìš”. ì˜ˆìƒë³´ë‹¤ ë§›ìˆê³  ì–‘ì´ ë§ì•„ì„œ ì¢…ì¢… ì‹œì¼œë¨¹ì–´ì•¼ê² ì–´ìš”."
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "23:03:00",
            "dateTime": "2023-06-25T23:03:00",
            "stamp": "ì¡¸ë¦¼",
            "memoLet": "í˜ë“  í•˜ë£¨ë¥¼ ë³´ëƒˆì–´ìš”"
        }
    ]
}
--------------------------------------------------------------------------------------------------------------------
{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 23,
        "gender": "ì—¬ì",
        "job": "ëŒ€í•™ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "12:04:00",
            "dateTime": "2023-06-25T13:12:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "í”¼ê³¤í•˜ì§€ë§Œ ì¼ë‹¨ í¬í•­ì— ë„ì°©í–ˆìŒ!!!! ê³ ì†ë²„ìŠ¤ 4ì‹œê°„ ì§„ì§œ ì‰½ì§€ì•Šë‹¤"
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "13:00:00",
            "dateTime": "2023-06-25T14:50:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "íŒ¨ë“¤ë³´ë“œ ë„ˆë¬´ ì¬ë°Œì—ˆì–´!!!! ì§„ì§œ ì˜¤ëœë§˜ì— í•´ì–‘ìŠ¤í¬ì¸  ë„˜ ì¬ë°Œì—ˆë‹¤"
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "18:00:00",
            "dateTime": "2023-06-25T19:10:00",
            "stamp": "ìš°ìš¸",
            "memoLet": "ë„ˆë¬´ ê±±ì •í–ˆëŠ”ë° ê´œì°®ì•„ ì¡Œë‹¤ê³  í•˜ë”ë¼ë„ ìŠ¹ì¬ë‘ ê°™ì´ ê°„ ê³³ì€ ì—¬ì „íˆ ë„ˆë¬´ í˜ë“¤ë‹¤ ë§ì´ ë³´ê³ ì‹¶ë‹¤"
        },
        {
            "kakaoId": "101010",
            "localDate": "2023-06-25",
            "localTime": "21:00:00",
            "dateTime": "2023-06-25T23:03:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "ê½ƒë¼ì§€ì‹ë‹¹ ë¼ì§€ê³ ê¸° ì¡´ë§›ì§„ì§œ..."
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-26T02:03:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "ìƒˆë²½ê¹Œì§€ ì¹œêµ¬ë“¤ì´ë‘ ìˆ  ë§ˆì‹œë‹ˆê¹Œ ì¬ë°Œë‹¤!"
        }
    ]
}

---------------------------------------------------------------------------------------------------------------------

{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 23,
        "gender": "ì—¬ì",
        "job": "ëŒ€í•™ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T12:00:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "ì•¨ë¦¬ìŠ¤êµìˆ˜ë‹˜ì´ í•™êµì—ì„œ 343ìœ¼ë¡œ í•™ì  ì¤€ë‹¤ê³  í•´ì„œ ì¢€ ë‹¹í™©ìŠ¤ëŸ¬ì›€.. í˜¹ì‹œ ì´ë²ˆì— A+ì•ˆì£¼ëŠ”ê±° ì•„ë‹ˆê² ì§€ ë‚˜ ì¢ƒë¼ìš” ì•ˆë¼.."
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T16:00:00",
            "stamp": "ìš°ìš¸",
            "memoLet": "ë‹¤í–‰íˆ ì €ë„ì€ ì—ì´ì  ë‚˜ì˜´!"
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T22:00:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "ì•¨ë¦¬ìŠ¤ êµìˆ˜ë‹˜ì´ ì´ˆëŒ€í•´ì„œ ì˜¤ëœë§Œì— ë°•ì¢…í›ˆ ì„ ë°°ë‘ ëµ€ëŠ”ë° ë„ˆë¬´ ì¢‹ì€ ì‹œê°„ì´ì—ˆë‹¤. ë‚˜ë„ ì„ ë°°ë‹˜ë”°ë¼ ë©‹ì§„ ì„ ë°°ë˜ê³ ì‹¶ë‹¤.."
        }
    ]
}

---------------------------------------------------------------------------------------------------------------------

{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 23,
        "gender": "ì—¬ì",
        "job": "ëŒ€í•™ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T14:00:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "ì§„ì§œ ì˜ìƒ í•™ì  ë¯¸ì¹œë“¯ì´ ì§œê²Œì¤Œ ë¯¸ì¹œê±°ì•„ë‹ˆëƒ ì•„.. ê·¸ë˜ì„œ êµìˆ˜ë‹˜í•œí…Œ ì¬í‰ê°€ ë©”ì¼ë“œë ·ë‹¤"
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T15:00:00",
            "stamp": "ìš°ìš¸",
            "memoLet": "ê°œì—´ë°›ìŒ ì˜ìƒ í•™ì  ì •ì •í•´ì¤€ê²Œ ì—ì´ì œë¡œ ì•„ ì‹œë°œ"
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T18:00:00",
            "stamp": "ê¸°ì¨",
            "memoLet": "ì§€ì›ì´ë‘ ì†Œí•˜ì—¼ì „ì´ë‘ ê·œì¹´ì¸  ë¨¹ìœ¼ëŸ¬ í™ì˜¨ê¸° ë‹¤ë…€ì˜´ ê¸°ë¶„ ì¢€ ì¢‹ì•„ì§"
        }
    ]
}

------------------------------------------------------------------------------------------------------------------------
{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 26,
        "gender": "ì—¬ì",
        "job": "ì·¨ì¤€ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T11:07:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "ìš°ë¦¬ íŒ€ì¥ë‹˜ì´ íŒ€ì›ë“¤ ì»¨ë””ì…˜ ì±™ê¸°ë¼ê³  ë°˜ë‚˜ì ˆ íœ´ê°€ë¥¼ ê¸°íší•˜ì…¨ë‹¤. ê·¼ë° íŒ€ì¥ë‹˜ì˜ ë°°ë ¤ë‘ì€ ë³„ê°œë¡œ ì˜¤ëŠ˜ ì•„ì¹¨ì— ê°œì¸ ì¼ì •ë•Œë¬¸ì— ì–´ì°¨í”¼ ì¼ì° 7ì‹œì— ì¼ì–´ë‚˜ì•¼ í–ˆë‹¤.. ìƒê°ë§Œìœ¼ë¡œë„ í”¼ê³¤í–ˆëŠ”ë°, ë§ˆì¹¨(?) ì•ŒëŒì„ ì˜ëª»ë“¤ì–´ì„œ 9ì‹œ ë°˜ì— ì¼ì–´ë‚˜ë²„ë ¸ë‹¤ ã…‹ã…‹ã…‹ã…‹ ê°œì¸ ì¼ì •ì—ëŠ” ë¬´ë ¤ ë‘ ì‹œê°„ì´ë‚˜ ì§€ê°í•˜ê² ì§€ë§Œ.. ì§€ê° ë•ë¶„ì— í‘¹ ì” ê²ƒ ê°™ì•„ì„œ ì¢‹ë‹¤ ã…ã…"
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-06-30T23:14:00",
            "stamp": "ìš°ìš¸",
            "memoLet": "ì˜¤ëŠ˜ í•˜ë£¨ ì¢…ì¼ ì—´ì‹¬íˆ ì‚´ì•˜ë‹¤..ë‚´ì¼ë„ ì•„ì¹¨ì¼ì°ë¶€í„° í•˜ë£¨ë¥¼ ì‹œì‘í•´ì•¼í•œë‹¤..ğŸ”¥ ì˜¤ëŠ˜ì€ ì¼ì° ì ì— ë“¤ì–´ë³´ì"
        }
    ]
}

-----------------------------------------------------------------------------------------------------------------------------
{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 22,
        "gender": "ë‚¨ì",
        "job": "ëŒ€í•™ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "dateTime": "2023-07-04T01:53:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "ì•„ì¹¨ì— ì¼ì–´ë‚˜ë©´ ì²­ì†Œë¶€í„° í•´ì•¼ê² ë‹¤... í˜íŠ¸ë³‘ì´ ë„ˆë¬´ ë§ë‹¤ ì¼ë„ ë‚´ì¼ ì•„ì¹¨ë¶€í„° í•˜ê³  ì œë°œ ì¼ì° ì¼ì–´ë‚˜ì ì¢€"
        }
    ]
}

------------------------------------------------------------------------------------------------------------------------------
{
    "userDto": {
        "kakaoId": "101010",
        "username": "ë¯¼ì„œ",
        "age": 26,
        "gender": "ì—¬ì",
        "job": "ì·¨ì¤€ìƒ"
    },
    "todayStampList": [
        {
            "kakaoId": "101010",
            "dateTime": "2023-07-04T14:24:00",
            "stamp": "í”¼ê³¤",
            "memoLet": "ì˜¤ëŠ˜ ì ì‹¬ë„ ë„ˆë¬´ ë§›ìˆì—ˆë‹¤ ì–´ì œë¶€í„° ì´í‹€ì§¸ í•œì‹ ë¨¹ëŠ”ì¤‘ì¸ë° ì§‘ë°¥ ë¨¹ëŠ” ê¸°ë¶„ì´ë„ê¹Œë‚˜â€¦ ìš”ìƒˆ ì§‘ë°¥ì„ ë„ˆë¬´ ëª»ë¨¹ì–´ì„œ ì•„ì‰¬ì›Œ ë°”ìœíƒ“ì— ê°€ì¡±ë“¤ì´ë‘ ë°¥ í•œ ë²ˆ ëª»ë¨¹ê³ ~~"
        },
        {
            "kakaoId": "101010",
            "dateTime": "2023-07-05T00:13:00",
            "stamp": "ìš°ìš¸",
            "memoLet": "ë…¸íŠ¸ë¶ ë‘ê³  ì˜¬ ëª©í‘œë¡œ ê°œë°œ ì—´ì‹¬íˆ í•˜ë‹¤ê°€ ë§‰ì°¨ ë˜ì—ˆëŠ”ë°ë„ ë§ˆë¬´ë¦¬ ì•ˆë˜ì–´ì„œ ã……ã…‚ ëƒ…ë‹¤ ê·¸ëƒ¥ ê°€ë°©ì— ë„£ê³  ë¹„ì˜¤ëŠ”ë°ë„ ê°œë›°ì—ˆëŠ”ë° ì§€í•˜ì² ì„ ëª»íƒ. ë‚˜ëŠ” ì œì‹œê°„ì— ì™”ëŠ”ë° 2í˜¸ì„ ì´ 6ë¶„ ì—°ì°©ë˜ì–´ì„œ ì™”ìŒ. ë•ë¶„ì— ì‹ ë¶„ë‹¹ì„  ë§‰ì°¨ ë†“ì³¤ìŒ ì´ëŸ° ê°œê°™ì€"
        }
    ]
}
"""    